<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Purchase Predictor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-shopping-cart"></i>
                    <h1>E-Commerce Purchase Predictor</h1>
                </div>
                <div class="user-info">
                    <i class="fas fa-user"></i>
                    <span>admin</span>
                    <span class="timestamp" id="current-timestamp">Loading...</span>
                </div>
            </div>
        </header>

        <main>
            <section class="info-panel">
                <div class="card">
                    <h2><i class="fas fa-info-circle"></i> About This Tool</h2>
                    <p>This tool uses machine learning to predict purchase likelihood based on user session data from the Kaggle e-commerce behavior dataset. It analyzes patterns in user behavior to identify high-intent customers.</p>
                </div>
                
                <div class="card session-info">
                    <h2><i class="fas fa-clock"></i> Session Info</h2>
                    <p><strong>Session started:</strong> <span id="session-start-time">Loading...</span></p>
                    <div id="status-message">Ready to analyze your e-commerce data.</div>
                </div>
            </section>

            <section class="action-panel">
                <div class="card">
                    <h2><i class="fas fa-cogs"></i> Model Training</h2>
                    <p>Train the machine learning model on e-commerce dataset to predict customer purchases.</p>
                    <div class="progress-container">
                        <div class="progress-bar" id="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                            <div class="progress-text" id="progress-text">0%</div>
                        </div>
                    </div>
                    <button id="start-pipeline" class="btn primary-btn">
                        <i class="fas fa-play"></i> Start Training Pipeline
                    </button>
                </div>

                <div class="card results hidden" id="results-section">
                    <h2><i class="fas fa-chart-line"></i> Model Results</h2>

                    <div class="tabs">
                        <button class="tab-btn active" data-tab="performance">Performance</button>
                        <button class="tab-btn" data-tab="features">Features</button>
                        <button class="tab-btn" data-tab="visualizations">Visualizations</button>
                        <button class="tab-btn" data-tab="advanced-viz">Advanced Charts</button>
                        <button class="tab-btn" data-tab="user-analytics">User Analytics</button>
                    </div>
                    
                    <div id="performance" class="tab-content active">
                        <h3>Model Performance</h3>
                        <div class="model-info">
                            <p><strong>Best Model:</strong> <span id="best-model">-</span></p>
                        </div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Accuracy</th>
                                    <th>F1 Score</th>
                                    <th>ROC AUC</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                                <!-- Results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="features" class="tab-content">
                        <h3>Important Features</h3>
                        <table class="feature-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Importance</th>
                                    <th>Visualization</th>
                                </tr>
                            </thead>
                            <tbody id="feature-table-body">
                                <!-- Feature data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="visualizations" class="tab-content">
                        <div class="plot-container">
                            <div class="plot">
                                <h3>Confusion Matrix</h3>
                                <img id="confusion-matrix" alt="Confusion Matrix" />
                            </div>
                            <div class="plot">
                                <h3>Precision-Recall Curve</h3>
                                <img id="precision-recall" alt="Precision-Recall Curve" />
                            </div>
                            <div class="plot">
                                <h3>Feature Importance</h3>
                                <img id="feature-importance" alt="Feature Importance" />
                            </div>
                            <div class="plot">
                                <h3>Model Comparison</h3>
                                <img id="model-comparison" alt="Model Comparison" />
                            </div>
                        </div>
                    </div>
                    
                    <div id="advanced-viz" class="tab-content">
                        <h3>Advanced Visualization</h3>
                        <div class="viz-controls">
                            <button id="load-advanced-viz" class="btn secondary-btn">
                                <i class="fas fa-chart-bar"></i> Load Advanced Charts
                            </button>
                        </div>
                        <div class="advanced-plot-container">
                            <div class="plot">
                                <h3>ROC Curve</h3>
                                <img id="roc-curve" alt="ROC Curve" />
                            </div>
                            <div class="plot">
                                <h3>Learning Curve</h3>
                                <img id="learning-curve" alt="Learning Curve" />
                            </div>
                            <div class="plot">
                                <h3>Purchase Distribution by Time</h3>
                                <img id="purchase-time-dist" alt="Purchase Distribution by Time" />
                            </div>
                            <div class="plot">
                                <h3>Purchase Distribution by Device</h3>
                                <img id="purchase-device-dist" alt="Purchase Distribution by Device" />
                            </div>
                            <div class="plot wide-plot">
                                <h3>Feature Correlation Heatmap</h3>
                                <img id="correlation-heatmap" alt="Feature Correlation Heatmap" />
                            </div>
                            <div class="plot wide-plot">
                                <h3>User Behavior Flow</h3>
                                <img id="user-flow" alt="User Behavior Flow Chart" />
                            </div>
                            <div class="plot">
                                <h3>Probability Distribution</h3>
                                <img id="prob-distribution" alt="Probability Distribution" />
                            </div>
                            <div class="plot">
                                <h3>Cumulative Gains Chart</h3>
                                <img id="cumulative-gains" alt="Cumulative Gains Chart" />
                            </div>
                        </div>
                    </div>
                    
                    <div id="user-analytics" class="tab-content">
                        <h3>User Analytics Dashboard</h3>
                        <div class="viz-controls">
                            <button id="load-user-analytics" class="btn secondary-btn">
                                <i class="fas fa-users"></i> Load User Analytics
                            </button>
                        </div>
                        <div class="user-analytics-summary" id="user-analytics-summary">
                            <!-- User analytics summary will be inserted here -->
                        </div>
                        <div class="user-analytics-plots">
                            <div class="plot">
                                <h3>Device Distribution</h3>
                                <img id="device-distribution" alt="Device Distribution" />
                            </div>
                            <div class="plot">
                                <h3>Hourly Activity Pattern</h3>
                                <img id="hourly-activity" alt="Hourly Activity Pattern" />
                            </div>
                            <div class="plot">
                                <h3>Purchase Funnel</h3>
                                <img id="purchase-funnel" alt="Purchase Funnel" />
                            </div>
                            <div class="plot">
                                <h3>User Retention</h3>
                                <img id="user-retention" alt="User Retention" />
                            </div>
                            <div class="plot wide-plot">
                                <h3>Category Performance</h3>
                                <img id="category-performance" alt="Category Performance" />
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="prediction-panel card" id="prediction-panel">
                <h2><i class="fas fa-magic"></i> Make Predictions</h2>
                <p>Predict purchase likelihood for a user session.</p>
                
                <div class="prediction-form">
                    <div class="form-group">
                        <label for="session_events">Number of Events</label>
                        <input type="number" id="session_events" name="session_events" min="1" value="5">
                    </div>
                    <div class="form-group">
                        <label for="avg_time_on_page">Avg. Time on Page (sec)</label>
                        <input type="number" id="avg_time_on_page" name="avg_time_on_page" min="0" step="0.1" value="45.0">
                    </div>
                    <div class="form-group">
                        <label for="total_time_on_site">Total Time on Site (sec)</label>
                        <input type="number" id="total_time_on_site" name="total_time_on_site" min="0" value="225">
                    </div>
                    <div class="form-group">
                        <label for="cart_adds">Items Added to Cart</label>
                        <input type="number" id="cart_adds" name="cart_adds" min="0" value="1">
                    </div>
                    <div class="form-group">
                        <label for="cart_to_event_ratio">Cart to Event Ratio</label>
                        <input type="number" id="cart_to_event_ratio" name="cart_to_event_ratio" min="0" step="0.01" value="0.2">
                    </div>
                    <div class="form-group">
                        <label for="device">Device</label>
                        <select id="device" name="device">
                            <option value="mobile">Mobile</option>
                            <option value="desktop">Desktop</option>
                            <option value="tablet">Tablet</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="browser">Browser</label>
                        <select id="browser" name="browser">
                            <option value="Chrome">Chrome</option>
                            <option value="Firefox">Firefox</option>
                            <option value="Safari">Safari</option>
                            <option value="Edge">Edge</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button id="random-session" class="btn secondary-btn">
                            <i class="fas fa-random"></i> Random Session
                        </button>
                        <button id="simulate-session" class="btn secondary-btn">
                            <i class="fas fa-play"></i> Simulate Session
                        </button>
                        <button id="predict-btn" class="btn primary-btn">
                            <i class="fas fa-search"></i> Predict
                        </button>
                    </div>
                </div>
                
                <div class="prediction-result hidden" id="prediction-result">
                    <h3>Prediction Result</h3>
                    <div class="meter">
                        <div class="meter-fill" id="probability-meter"></div>
                        <div class="meter-text" id="probability-text">--</div>
                    </div>
                    <p class="recommendation" id="recommendation"></p>
                    <div class="factor-analysis" id="factor-analysis">
                        <h4>Contributing Factors</h4>
                        <div class="factors-container" id="factors-container">
                            <!-- Contributing factors will appear here -->
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="dataset-panel card" id="dataset-panel">
                <h2><i class="fas fa-database"></i> Dataset Information</h2>
                <p>Information about the dataset used for training and sample data.</p>
                
                <div class="dataset-controls">
                    <button id="show-dataset-info" class="btn secondary-btn">
                        <i class="fas fa-info-circle"></i> Show Dataset Info
                    </button>
                    <button id="download-sample" class="btn primary-btn">
                        <i class="fas fa-download"></i> Download Sample Dataset
                    </button>
                </div>
                
                <div class="dataset-info hidden" id="dataset-info-panel">
                    <h3>Dataset Overview</h3>
                    <div id="dataset-info-content">
                        <!-- Dataset info will be inserted here -->
                    </div>
                    
                    <h3>Preview</h3>
                    <div class="table-container">
                        <table class="dataset-preview" id="dataset-preview">
                            <!-- Dataset preview will be inserted here -->
                        </table>
                    </div>
                </div>
            </section>

            <section class="simulation-panel card hidden" id="simulation-panel">
                <h2><i class="fas fa-film"></i> Session Simulation</h2>
                <p>Visualize a simulated user session with events and predictions.</p>
                
                <div class="simulation-controls">
                    <div class="form-group">
                        <label for="sim_events">Number of Events:</label>
                        <input type="number" id="sim_events" name="sim_events" min="2" max="15" value="5">
                    </div>
                    <div class="form-group">
                        <label for="include_purchase">Include Purchase:</label>
                        <input type="checkbox" id="include_purchase" name="include_purchase">
                    </div>
                    <button id="run-simulation" class="btn primary-btn">
                        <i class="fas fa-play"></i> Run Simulation
                    </button>
                </div>
                
                <div class="simulation-result hidden" id="simulation-result">
                    <div class="session-timeline" id="session-timeline">
                        <!-- Session timeline will be inserted here -->
                    </div>
                    
                    <div class="session-metrics">
                        <h3>Session Summary</h3>
                        <div id="session-metrics-content">
                            <!-- Session metrics will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="prediction-box" id="simulation-prediction">
                        <h3>Purchase Prediction</h3>
                        <div class="meter">
                            <div class="meter-fill" id="sim-probability-meter"></div>
                            <div class="meter-text" id="sim-probability-text">--</div>
                        </div>
                        <p class="accuracy-indicator" id="accuracy-indicator"></p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; <span id="current-year">2025</span> E-Commerce Purchase Predictor | Data source: Kaggle | User: admin | Updated: <span id="footer-timestamp">Loading...</span></p>
        </footer>
    </div>

    <script>
        // Global variables
        let taskId = null;
        let intervalId = null;

        // Update timestamps regularly
        function updateTimestamps() {
            const now = new Date();
            const options = { 
                year: 'numeric', month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            };
            
            const formattedDate = now.toLocaleDateString('en-US', options);
            
            // Update all timestamps on the page
            document.getElementById('current-timestamp').textContent = formattedDate;
            document.getElementById('session-start-time').textContent = formattedDate;
            document.getElementById('footer-timestamp').textContent = formattedDate;
            document.getElementById('current-year').textContent = now.getFullYear();
        }

        // Update timestamps immediately and then every second
        updateTimestamps();
        setInterval(updateTimestamps, 1000);

        // DOM Element References
        const startButton = document.getElementById('start-pipeline');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const statusMessage = document.getElementById('status-message');
        const resultsSection = document.getElementById('results-section');
        const predictBtn = document.getElementById('predict-btn');
        const randomSessionBtn = document.getElementById('random-session');
        const predictionResult = document.getElementById('prediction-result');
        const simulateSessionBtn = document.getElementById('simulate-session');
        const simulationPanel = document.getElementById('simulation-panel');
        const showDatasetInfoBtn = document.getElementById('show-dataset-info');
        const datasetInfoPanel = document.getElementById('dataset-info-panel');
        const downloadSampleBtn = document.getElementById('download-sample');

        // Start the pipeline
        startButton.addEventListener('click', function() {
            startButton.disabled = true;
            startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            statusMessage.innerHTML = 'Starting ML pipeline...';
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            
            // Call the API to start the pipeline
            fetch('/start_pipeline', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                taskId = data.task_id;
                checkStatus();
                intervalId = setInterval(checkStatus, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                statusMessage.innerHTML = 'Error starting pipeline';
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play"></i> Start Training Pipeline';
            });
        });

        // Check task status
        function checkStatus() {
            if (!taskId) return;
            
            fetch(`/check_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const progress = data.progress || 0;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    
                    if (data.status === 'completed') {
                        clearInterval(intervalId);
                        statusMessage.innerHTML = 'ML pipeline completed successfully!';
                        startButton.disabled = false;
                        startButton.innerHTML = '<i class="fas fa-check-circle"></i> Training Complete';
                        
                        // Load results and plots
                        loadResults();
                        loadPlots();
                        resultsSection.classList.remove('hidden');
                    } else if (data.status === 'failed') {
                        clearInterval(intervalId);
                        statusMessage.innerHTML = `Error: ${data.error || 'Pipeline failed'}`;
                        startButton.disabled = false;
                        startButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Training Failed';
                    } else {
                        statusMessage.innerHTML = `Processing: ${progress}% complete`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Load model results
        function loadResults() {
            fetch('/get_results')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Update best model
                    document.getElementById('best-model').textContent = data.best_model;
                    
                    // Update results table
                    const tableBody = document.getElementById('results-table-body');
                    tableBody.innerHTML = '';
                    
                    for (const [name, result] of Object.entries(data.results)) {
                        const row = document.createElement('tr');
                        if (name === data.best_model) {
                            row.classList.add('best-model');
                        }
                        
                        row.innerHTML = `
                            <td>${name}</td>
                            <td>${(result.accuracy * 100).toFixed(2)}%</td>
                            <td>${(result.f1_score * 100).toFixed(2)}%</td>
                            <td>${(result.roc_auc * 100).toFixed(2)}%</td>
                        `;
                        tableBody.appendChild(row);
                    }
                    
                    // Update feature importance table
                    const featureBody = document.getElementById('feature-table-body');
                    featureBody.innerHTML = '';
                    
                    data.feature_importance.forEach((item) => {
                        const row = document.createElement('tr');
                        const barWidth = (item.importance / data.feature_importance[0].importance) * 100;
                        
                        row.innerHTML = `
                            <td>${item.feature}</td>
                            <td>${item.importance.toFixed(4)}</td>
                            <td>
                                <div class="feature-bar-container">
                                    <div class="feature-bar" style="width: ${barWidth}%"></div>
                                </div>
                            </td>
                        `;
                        featureBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Load plots
        function loadPlots() {
            fetch('/get_plots')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Update plot images
                    document.getElementById('confusion-matrix').src = `data:image/png;base64,${data.confusion_matrix}`;
                    document.getElementById('precision-recall').src = `data:image/png;base64,${data.precision_recall}`;
                    document.getElementById('feature-importance').src = `data:image/png;base64,${data.feature_importance}`;
                    document.getElementById('model-comparison').src = `data:image/png;base64,${data.model_comparison}`;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // Load advanced visualizations
        document.getElementById('load-advanced-viz').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            fetch('/get_advanced_plots')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Update advanced plot images
                    document.getElementById('roc-curve').src = `data:image/png;base64,${data.roc_curve}`;
                    document.getElementById('learning-curve').src = `data:image/png;base64,${data.learning_curve}`;
                    document.getElementById('purchase-time-dist').src = `data:image/png;base64,${data.purchase_time_dist}`;
                    document.getElementById('purchase-device-dist').src = `data:image/png;base64,${data.purchase_device_dist}`;
                    document.getElementById('correlation-heatmap').src = `data:image/png;base64,${data.correlation_heatmap}`;
                    document.getElementById('user-flow').src = `data:image/png;base64,${data.user_flow}`;
                    document.getElementById('prob-distribution').src = `data:image/png;base64,${data.prob_distribution}`;
                    document.getElementById('cumulative-gains').src = `data:image/png;base64,${data.cumulative_gains}`;
                    
                    // Re-enable the button
                    document.getElementById('load-advanced-viz').disabled = false;
                    document.getElementById('load-advanced-viz').innerHTML = '<i class="fas fa-chart-bar"></i> Refresh Charts';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('load-advanced-viz').disabled = false;
                    document.getElementById('load-advanced-viz').innerHTML = '<i class="fas fa-chart-bar"></i> Load Advanced Charts';
                });
        });

        // Load user analytics
        document.getElementById('load-user-analytics').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            fetch('/get_user_analytics')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Update user analytics summary
                    const summaryContainer = document.getElementById('user-analytics-summary');
                    let summaryHTML = '<div class="analytics-cards">';
                    
                    if (data.purchase_metrics) {
                        const metrics = data.purchase_metrics;
                        summaryHTML += `
                            <div class="analytics-card">
                                <h4>Purchase Metrics</h4>
                                <p><strong>Total Users:</strong> ${metrics.total_users}</p>
                                <p><strong>Purchasing Users:</strong> ${metrics.purchasing_users}</p>
                                <p><strong>Conversion Rate:</strong> ${metrics.conversion_rate}%</p>
                                <p><strong>Avg Purchases Per Buyer:</strong> ${metrics.avg_purchases_per_buyer}</p>
                            </div>
                        `;
                    }
                    
                    if (data.time_analytics) {
                        const peakHour = Object.entries(data.time_analytics.hourly_activity)
                            .sort((a, b) => b[1] - a[1])[0][0];
                        const peakPurchaseHour = Object.entries(data.time_analytics.hourly_purchases || {})
                            .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
                        
                        summaryHTML += `
                            <div class="analytics-card">
                                <h4>Time-Based Analytics</h4>
                                <p><strong>Peak Activity Hour:</strong> ${peakHour}</p>
                                <p><strong>Peak Purchase Hour:</strong> ${peakPurchaseHour}</p>
                            </div>
                        `;
                    }
                    
                    if (data.device_analytics) {
                        const topDevice = Object.entries(data.device_analytics.device_counts)
                            .sort((a, b) => b[1] - a[1])[0][0];
                        
                        summaryHTML += `
                            <div class="analytics-card">
                                <h4>Device Analytics</h4>
                                <p><strong>Top Device:</strong> ${topDevice}</p>
                            </div>
                        `;
                    }
                    
                    if (data.session_analytics) {
                        const sessionAnalytics = data.session_analytics;
                        
                        summaryHTML += `
                            <div class="analytics-card">
                                <h4>Session Analytics</h4>
                                <p><strong>Total Sessions:</strong> ${sessionAnalytics.total_sessions}</p>
                                <p><strong>Avg Duration:</strong> ${sessionAnalytics.avg_session_duration_minutes.toFixed(1)} mins</p>
                                <p><strong>Avg Events:</strong> ${sessionAnalytics.avg_events_per_session.toFixed(1)}</p>
                            </div>
                        `;
                    }
                    
                    summaryHTML += '</div>';
                    summaryContainer.innerHTML = summaryHTML;
                    
                    // Update user analytics plots
                    if (data.plots) {
                        if (data.plots.device_distribution) {
                            document.getElementById('device-distribution').src = `data:image/png;base64,${data.plots.device_distribution}`;
                        }
                        if (data.plots.hourly_activity) {
                            document.getElementById('hourly-activity').src = `data:image/png;base64,${data.plots.hourly_activity}`;
                        }
                        if (data.plots.purchase_funnel) {
                            document.getElementById('purchase-funnel').src = `data:image/png;base64,${data.plots.purchase_funnel}`;
                        }
                        if (data.plots.user_retention) {
                            document.getElementById('user-retention').src = `data:image/png;base64,${data.plots.user_retention}`;
                        }
                        if (data.plots.category_performance) {
                            document.getElementById('category-performance').src = `data:image/png;base64,${data.plots.category_performance}`;
                        }
                    }
                    
                    // Re-enable the button
                    document.getElementById('load-user-analytics').disabled = false;
                    document.getElementById('load-user-analytics').innerHTML = '<i class="fas fa-users"></i> Refresh Analytics';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('load-user-analytics').disabled = false;
                    document.getElementById('load-user-analytics').innerHTML = '<i class="fas fa-users"></i> Load User Analytics';
                });
        });

        // Tab functionality
        function openTab(evt, tabName) {
            // Hide all tab content
            const tabContent = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove('active');
            }
            
            // Remove active class from tab buttons
            const tabButtons = document.getElementsByClassName('tab-btn');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show the selected tab and add active class
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Get random session
        randomSessionBtn.addEventListener('click', function() {
            fetch('/get_random_session')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    // Fill form with random session data
                    document.getElementById('session_events').value = data.session_events;
                    document.getElementById('avg_time_on_page').value = data.avg_time_on_page;
                    document.getElementById('total_time_on_site').value = data.total_time_on_site;
                    document.getElementById('cart_adds').value = data.cart_adds;
                    document.getElementById('cart_to_event_ratio').value = data.cart_to_event_ratio;
                    
                    // Set select values if they exist
                    if (data.device) {
                        const deviceSelect = document.getElementById('device');
                        for (let i = 0; i < deviceSelect.options.length; i++) {
                            if (deviceSelect.options[i].value.toLowerCase() === data.device.toLowerCase()) {
                                deviceSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    if (data.browser) {
                        const browserSelect = document.getElementById('browser');
                        for (let i = 0; i < browserSelect.options.length; i++) {
                            if (browserSelect.options[i].value.toLowerCase() === data.browser.toLowerCase()) {
                                browserSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        // Show simulation panel
        simulateSessionBtn.addEventListener('click', function() {
            simulationPanel.classList.remove('hidden');
            
            // Scroll to the simulation panel
            simulationPanel.scrollIntoView({ behavior: 'smooth' });
        });

        // Run session simulation
        document.getElementById('run-simulation').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Simulating...';
            
            const numEvents = document.getElementById('sim_events').value;
            const includePurchase = document.getElementById('include_purchase').checked;
            
            fetch('/simulate_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    num_events: numEvents,
                    include_purchase: includePurchase
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                // Show simulation result
                document.getElementById('simulation-result').classList.remove('hidden');
                
                // Create timeline
                const timeline = document.getElementById('session-timeline');
                timeline.innerHTML = '';
                
                let timelineHTML = '<div class="timeline">';
                data.events.forEach((event, index) => {
                    const isLast = index === data.events.length - 1;
                    
                    let eventIconClass = 'fa-eye';
                    let eventClass = 'view-event';
                    
                    if (event.event_type === 'cart') {
                        eventIconClass = 'fa-cart-plus';
                        eventClass = 'cart-event';
                    } else if (event.event_type === 'purchase') {
                        eventIconClass = 'fa-credit-card';
                        eventClass = 'purchase-event';
                    }
                    
                    timelineHTML += `
                        <div class="timeline-item ${eventClass}">
                            <div class="timeline-icon">
                                <i class="fas ${eventIconClass}"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>Event ${event.event_number}: ${event.event_type}</h4>
                                <p><strong>Time:</strong> ${event.timestamp}</p>
                                <p><strong>Product ID:</strong> ${event.product_id}</p>
                                <p><strong>Time on page:</strong> ${event.time_on_page}s</p>
                            </div>
                            ${!isLast ? '<div class="timeline-connector"></div>' : ''}
                        </div>
                    `;
                });
                timelineHTML += '</div>';
                timeline.innerHTML = timelineHTML;
                
                // Update session metrics
                const metricsContent = document.getElementById('session-metrics-content');
                metricsContent.innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric">
                            <span class="metric-value">${data.session_metrics.session_events}</span>
                            <span class="metric-label">Events</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${data.session_metrics.cart_adds}</span>
                            <span class="metric-label">Cart Adds</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${Math.round(data.session_metrics.avg_time_on_page)}s</span>
                            <span class="metric-label">Avg Time/Page</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">${Math.round(data.session_metrics.total_time_on_site)}s</span>
                            <span class="metric-label">Total Time</span>
                        </div>
                    </div>
                    <div class="session-details">
                        <p><strong>Device:</strong> ${data.session_metrics.device}</p>
                        <p><strong>Browser:</strong> ${data.session_metrics.browser}</p>
                        <p><strong>User ID:</strong> ${data.events[0].user_id}</p>
                        <p><strong>Session ID:</strong> ${data.events[0].session_id}</p>
                    </div>
                `;
                
                // Update prediction meter
                if (data.prediction) {
                    const probabilityPercent = parseFloat(data.prediction.probability) * 100;
                    document.getElementById('sim-probability-meter').style.width = `${probabilityPercent}%`;
                    document.getElementById('sim-probability-text').textContent = data.prediction.probability_percent;
                    
                    // Set meter color based on probability
                    const meterFill = document.getElementById('sim-probability-meter');
                    if (probabilityPercent < 30) {
                        meterFill.className = 'meter-fill low';
                    } else if (probabilityPercent < 70) {
                        meterFill.className = 'meter-fill medium';
                    } else {
                        meterFill.className = 'meter-fill high';
                    }
                    
                    // Show accuracy indicator 
                    const accuracyIndicator = document.getElementById('accuracy-indicator');
                    if (data.has_purchase) {
                        if (probabilityPercent >= 50) {
                            accuracyIndicator.textContent = '✓ Correct Prediction (True Positive)';
                            accuracyIndicator.className = 'accuracy-indicator correct';
                        } else {
                            accuracyIndicator.textContent = '✗ Incorrect Prediction (False Negative)';
                            accuracyIndicator.className = 'accuracy-indicator incorrect';
                        }
                    } else {
                        if (probabilityPercent < 50) {
                            accuracyIndicator.textContent = '✓ Correct Prediction (True Negative)';
                            accuracyIndicator.className = 'accuracy-indicator correct';
                        } else {
                            accuracyIndicator.textContent = '✗ Incorrect Prediction (False Positive)';
                            accuracyIndicator.className = 'accuracy-indicator incorrect';
                        }
                    }
                }
                
                // Re-enable the button
                document.getElementById('run-simulation').disabled = false;
                document.getElementById('run-simulation').innerHTML = '<i class="fas fa-play"></i> Run Simulation';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('run-simulation').disabled = false;
                document.getElementById('run-simulation').innerHTML = '<i class="fas fa-play"></i> Run Simulation';
            });
        });

        // Show dataset info
        showDatasetInfoBtn.addEventListener('click', function() {
            if (datasetInfoPanel.classList.contains('hidden')) {
                showDatasetInfoBtn.disabled = true;
                showDatasetInfoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                
                fetch('/get_sample_dataset_info')
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error:', data.error);
                            return;
                        }
                        
                        // Update dataset info
                        const infoContent = document.getElementById('dataset-info-content');
                        const info = data.info;
                        
                        infoContent.innerHTML = `
                            <div class="info-grid">
                                <div class="info-item">
                                    <h4>Basic Info</h4>
                                    <p><strong>File:</strong> ${info.filename}</p>
                                    <p><strong>Size:</strong> ${info.file_size}</p>
                                    <p><strong>Rows:</strong> ${info.rows.toLocaleString()}</p>
                                    <p><strong>Columns:</strong> ${info.columns}</p>
                                </div>
                                <div class="info-item">
                                    <h4>Data Elements</h4>
                                    <p><strong>Users:</strong> ${info.unique_users.toLocaleString()}</p>
                                    <p><strong>Products:</strong> ${info.unique_products.toLocaleString()}</p>
                                    <p><strong>Sessions:</strong> ${info.unique_sessions.toLocaleString()}</p>
                                    <p><strong>Event Types:</strong> ${info.event_types.join(', ')}</p>
                                </div>
                                <div class="info-item">
                                    <h4>Date Range</h4>
                                    <p><strong>From:</strong> ${info.date_range[0]}</p>
                                    <p><strong>To:</strong> ${info.date_range[1]}</p>
                                </div>
                            </div>
                        `;
                        
                        // Update dataset preview
                        const previewTable = document.getElementById('dataset-preview');
                        
                        if (data.preview && data.preview.length > 0) {
                            let tableHTML = '<thead><tr>';
                            
                            // Add headers
                            Object.keys(data.preview[0]).forEach(key => {
                                tableHTML += `<th>${key}</th>`;
                            });
                            
                            tableHTML += '</tr></thead><tbody>';
                            
                            // Add rows
                            data.preview.forEach(row => {
                                tableHTML += '<tr>';
                                Object.values(row).forEach(value => {
                                    tableHTML += `<td>${value}</td>`;
                                });
                                tableHTML += '</tr>';
                            });
                            
                            tableHTML += '</tbody>';
                            previewTable.innerHTML = tableHTML;
                        } else {
                            previewTable.innerHTML = '<tr><td>No preview available</td></tr>';
                        }
                        
                        // Show the panel
                        datasetInfoPanel.classList.remove('hidden');
                        
                        // Update button
                        showDatasetInfoBtn.disabled = false;
                        showDatasetInfoBtn.innerHTML = '<i class="fas fa-info-circle"></i> Hide Dataset Info';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showDatasetInfoBtn.disabled = false;
                        showDatasetInfoBtn.innerHTML = '<i class="fas fa-info-circle"></i> Show Dataset Info';
                    });
            } else {
                // Hide the panel
                datasetInfoPanel.classList.add('hidden');
                showDatasetInfoBtn.innerHTML = '<i class="fas fa-info-circle"></i> Show Dataset Info';
            }
        });

        // Download sample dataset
        downloadSampleBtn.addEventListener('click', function() {
            window.location.href = '/download_sample_dataset';
        });

        // Make prediction
        predictBtn.addEventListener('click', function() {
            const sessionData = {
                session_events: document.getElementById('session_events').value,
                avg_time_on_page: document.getElementById('avg_time_on_page').value,
                total_time_on_site: document.getElementById('total_time_on_site').value,
                cart_adds: document.getElementById('cart_adds').value,
                cart_to_event_ratio: document.getElementById('cart_to_event_ratio').value,
                device: document.getElementById('device').value,
                browser: document.getElementById('browser').value
            };
            
            // Disable button and show loading
            predictBtn.disabled = true;
            predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Predicting...';
            
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sessionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                // Show prediction result
                predictionResult.classList.remove('hidden');
                
                // Update probability meter
                const probabilityPercent = parseFloat(data.probability) * 100;
                document.getElementById('probability-meter').style.width = `${probabilityPercent}%`;
                document.getElementById('probability-text').textContent = data.probability_percent;
                
                // Set meter color based on probability
                const meterFill = document.getElementById('probability-meter');
                if (probabilityPercent < 30) {
                    meterFill.className = 'meter-fill low';
                } else if (probabilityPercent < 70) {
                    meterFill.className = 'meter-fill medium';
                } else {
                    meterFill.className = 'meter-fill high';
                }
                
                // Update recommendation
                document.getElementById('recommendation').textContent = data.recommendation;
                
                // Update contributing factors if available
                if (data.factors) {
                    const factorsContainer = document.getElementById('factors-container');
                    factorsContainer.innerHTML = '';
                    
                    data.factors.forEach(factor => {
                        const factorElement = document.createElement('div');
                        factorElement.className = 'factor';
                        factorElement.innerHTML = `
                            <span class="factor-name">${factor.name}</span>
                            <div class="factor-impact-container">
                                <div class="factor-impact" style="width: ${Math.abs(factor.impact) * 100}%; 
                                     background-color: ${factor.impact > 0 ? '#4caf50' : '#f44336'}"></div>
                            </div>
                            <span class="factor-value">${factor.value}</span>
                        `;
                        factorsContainer.appendChild(factorElement);
                    });
                    
                    document.getElementById('factor-analysis').style.display = 'block';
                } else {
                    document.getElementById('factor-analysis').style.display = 'none';
                }
                
                // Re-enable button
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<i class="fas fa-search"></i> Predict';
            })
            .catch(error => {
                console.error('Error:', error);
                predictBtn.disabled = false;
                predictBtn.innerHTML = '<i class="fas fa-search"></i> Predict';
            });
        });
        
    </script>
    

<script>
    // Initialize tab functionality (to be safe in case app.js fails to load)
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                const tabName = this.getAttribute('data-tab');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active class from all buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show the selected tab content
                if (document.getElementById(tabName)) {
                    document.getElementById(tabName).classList.add('active');
                }
                
                // Add active class to clicked button
                this.classList.add('active');
            });
        });
    });
  
</script>
            <!-- Modal for enlarged plots -->
    <div id="image-modal" class="modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-image" />
        <div class="modal-caption" id="modal-caption"></div>
</div>
<script>
    // Graph popup functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Set up click handler for all plot images
        document.querySelectorAll('.plot img').forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function() {
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('modal-image');
                const captionText = document.getElementById('modal-caption');
                
                modal.style.display = "flex";
                modalImg.src = this.src;
                
                // Try to get the caption from nearest h3
                let caption = "Visualization";
                const closestH3 = this.closest('.plot').querySelector('h3');
                if (closestH3) {
                    caption = closestH3.textContent;
                }
                captionText.innerHTML = caption;
            });
        });
        
        // Close modal when clicking on X
        const closeBtn = document.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.onclick = function() {
                document.getElementById('image-modal').style.display = "none";
            }
        }
        
        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                document.getElementById('image-modal').style.display = "none";
            }
        });
    });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/tabfix.js') }}"></script>
</body>
</html>